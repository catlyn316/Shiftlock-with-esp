-- Roblox ShiftLock + ESP 腳本
-- 功能：視角鎖定、面向最近玩家、面向雙擊玩家、ESP透視

-- 防止重複執行清理舊介面
local CoreGui = game:GetService("CoreGui")
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local Workspace = game:GetService("Workspace")

if CoreGui:FindFirstChild("ShiftLockUI") then CoreGui.ShiftLockUI:Destroy() end
if playerGui:FindFirstChild("ShiftLockUI") then playerGui.ShiftLockUI:Destroy() end

local function loadShiftLock()
    local ref = cloneref or function(x) return x end
    local S = function(n) return ref(game:GetService(n)) end

    local Plrs, Tw, UIS, RS, Wk, CG =
        S("Players"), S("TweenService"), S("UserInputService"), S("RunService"), S("Workspace"), S("CoreGui")

    local plr = Plrs.LocalPlayer

    local function parentUI(g)
        if gethui then
            g.Name = "\0" .. g.Name
            g.Parent = gethui()
            return g
        elseif CG then
            g.Parent = CG
            return g
        else
            g.Parent = plr:WaitForChild("PlayerGui")
            return g
        end
    end

    local function getParts()
        local c = plr.Character or plr.CharacterAdded:Wait()
        local hum = c:FindFirstChildOfClass("Humanoid") or c:WaitForChild("Humanoid")
        local hrp = c:FindFirstChild("HumanoidRootPart") or c:WaitForChild("HumanoidRootPart")
        return c, hum, hrp
    end

    local function lockMouse(v)
        if UIS.MouseEnabled then
            UIS.MouseBehavior = v and Enum.MouseBehavior.LockCenter or Enum.MouseBehavior.Default
        end
    end

    -- 狀態管理
    local lockMode = "none" 
    local rotCon = nil
    local targetPlayer = nil
    local mouseClickConn = nil
    local lastClickTime = 0
    local lastClickedPlayer = nil

    local gui = Instance.new("ScreenGui")
    gui.Name = "ShiftLockUI"
    gui.ResetOnSpawn = false
    gui.IgnoreGuiInset = true
    parentUI(gui)

    -- 按鈕變數
    local btn, nearBtn, clickBtn, espBtn, strk, icn

    local function updateButtonState(button, active)
        local activeColor = Color3.fromRGB(50, 100, 150)
        local inactiveColor = Color3.fromRGB(40, 40, 45)
        
        Tw:Create(button, TweenInfo.new(0.2), {
            BackgroundColor3 = active and activeColor or inactiveColor
        }):Play()
        
        local stroke = button:FindFirstChild("BtnStroke")
        if stroke then
            Tw:Create(stroke, TweenInfo.new(0.2), {
                Color = active and Color3.fromRGB(0, 200, 255) or Color3.fromRGB(80, 80, 90),
                Thickness = active and 2 or 1
            }):Play()
        end
    end

    local function clearAllModes()
        if rotCon then rotCon:Disconnect(); rotCon = nil end
        if mouseClickConn then mouseClickConn:Disconnect(); mouseClickConn = nil end
        lockMouse(false)
        local _, h, _ = getParts()
        if h then h.AutoRotate = true end
        icn.Image = "rbxasset://textures/ui/mouseLock_off.png"
        Tw:Create(strk, TweenInfo.new(0.2), {Color = Color3.fromRGB(0, 140, 255), Thickness = 2}):Play()
        Tw:Create(btn, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(34, 34, 38)}):Play()
        updateButtonState(nearBtn, false)
        updateButtonState(clickBtn, false)
        lockMode = "none"
        targetPlayer = nil
        lastClickedPlayer = nil
    end

    local function setFaceRotation(type, target)
        if rotCon then rotCon:Disconnect() end
        local _, h, r = getParts()
        h.AutoRotate = false
        
        rotCon = RS.RenderStepped:Connect(function()
            local _, _, myHRP = getParts()
            if not myHRP then return end
            local lookAtPos = nil
            
            if type == "nearest" then
                local nearest, minDist = nil, math.huge
                for _, p in ipairs(Plrs:GetPlayers()) do
                    if p ~= plr and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
                        local pRoot = p.Character.HumanoidRootPart
                        local d = (myHRP.Position - pRoot.Position).Magnitude
                        if d < minDist then minDist = d; nearest = pRoot end
                    end
                end
                if nearest then lookAtPos = nearest.Position end
            elseif type == "click" and target and target.Character then
                local pRoot = target.Character:FindFirstChild("HumanoidRootPart")
                if pRoot then lookAtPos = pRoot.Position end
            elseif type == "shiftlock" then
                local cam = Wk.CurrentCamera
                if cam then
                    local lv = cam.CFrame.LookVector
                    lookAtPos = myHRP.Position + Vector3.new(lv.X, 0, lv.Z)
                end
            end
            
            if lookAtPos then
                local flatDir = (lookAtPos - myHRP.Position) * Vector3.new(1, 0, 1)
                if flatDir.Magnitude > 0.001 then
                    myHRP.CFrame = CFrame.lookAt(myHRP.Position, myHRP.Position + flatDir.Unit, Vector3.yAxis)
                end
            end
        end)
    end

    -- UI 創建
    btn = Instance.new("ImageButton")
    btn.Name = "LockBtn"; btn.AnchorPoint = Vector2.new(0.5, 0.5); btn.Size = UDim2.fromOffset(64, 64)
    btn.Position = UDim2.new(1, -30, 1, -30); btn.BackgroundColor3 = Color3.fromRGB(34, 34, 38)
    btn.AutoButtonColor = false; btn.Parent = gui
    local cr = Instance.new("UICorner"); cr.CornerRadius = UDim.new(1, 0); cr.Parent = btn
    strk = Instance.new("UIStroke"); strk.Thickness = 2; strk.Color = Color3.fromRGB(0, 140, 255); strk.Parent = btn
    icn = Instance.new("ImageLabel")
    icn.Name = "Icn"; icn.BackgroundTransparency = 1; icn.AnchorPoint = Vector2.new(0.5, 0.5)
    icn.Position = UDim2.fromScale(0.5, 0.5); icn.Size = UDim2.fromScale(0.62, 0.62)
    icn.Image = "rbxasset://textures/ui/mouseLock_off.png"; icn.Parent = btn

    -- 專用拖曳把手
    local dragHandle = Instance.new("Frame")
    dragHandle.Name = "DragHandle"
    dragHandle.AnchorPoint = Vector2.new(0.5, 1)
    dragHandle.Position = UDim2.new(0.5, 0, 0, -2)
    dragHandle.Size = UDim2.fromOffset(40, 6)
    dragHandle.BackgroundColor3 = Color3.fromRGB(100, 100, 110)
    dragHandle.BorderSizePixel = 0
    dragHandle.Parent = btn
    
    local handleCorner = Instance.new("UICorner")
    handleCorner.CornerRadius = UDim.new(1, 0)
    handleCorner.Parent = dragHandle
    
    -- 拖曳把手的視覺提示（3個小點）
    local dot1 = Instance.new("Frame")
    dot1.Size = UDim2.fromOffset(2, 2)
    dot1.Position = UDim2.new(0.3, 0, 0.5, -1)
    dot1.BackgroundColor3 = Color3.fromRGB(200, 200, 200)
    dot1.BorderSizePixel = 0
    dot1.Parent = dragHandle
    Instance.new("UICorner", dot1).CornerRadius = UDim.new(1, 0)
    
    local dot2 = dot1:Clone()
    dot2.Position = UDim2.new(0.5, 0, 0.5, -1)
    dot2.Parent = dragHandle
    
    local dot3 = dot1:Clone()
    dot3.Position = UDim2.new(0.7, 0, 0.5, -1)
    dot3.Parent = dragHandle

    local xBtn = Instance.new("TextButton")
    xBtn.Name = "Close"; xBtn.AnchorPoint = Vector2.new(1, 0); xBtn.Position = UDim2.new(1, 5, 0, -5)
    xBtn.Size = UDim2.fromOffset(18, 18); xBtn.BackgroundColor3 = Color3.fromRGB(230, 60, 60); xBtn.Text = "×"
    xBtn.TextSize = 14; xBtn.TextColor3 = Color3.new(1, 1, 1); xBtn.Parent = btn
    Instance.new("UICorner").Parent = xBtn

    local extBtn = Instance.new("TextButton")
    extBtn.Name = "ExtendBtn"; extBtn.AnchorPoint = Vector2.new(0.5, 1); extBtn.Position = UDim2.new(0.5, 0, 0, -15)
    extBtn.Size = UDim2.fromOffset(56, 22); extBtn.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
    extBtn.Text = "延伸"; extBtn.TextSize = 12
    extBtn.TextColor3 = Color3.new(1, 1, 1)
    extBtn.Parent = btn
    Instance.new("UICorner").Parent = extBtn

    local extFrame = Instance.new("Frame")
    extFrame.Name = "ExtFrame"; extFrame.AnchorPoint = Vector2.new(0.5, 1); extFrame.Position = UDim2.new(0.5, 0, 0, -42)
    extFrame.Size = UDim2.fromOffset(64, 0); extFrame.BackgroundTransparency = 1; extFrame.ClipsDescendants = true; extFrame.Parent = btn

    local function createExtraBtn(name, yPos)
        local b = Instance.new("TextButton")
        b.Name = name; b.Size = UDim2.fromOffset(60, 26); b.Position = UDim2.fromOffset(2, yPos)
        b.BackgroundColor3 = Color3.fromRGB(40, 40, 45); b.Text = name; b.TextSize = 11; b.TextColor3 = Color3.new(1,1,1); b.Parent = extFrame
        local c = Instance.new("UICorner"); c.CornerRadius = UDim.new(0.2,0); c.Parent = b
        local s = Instance.new("UIStroke"); s.Thickness = 1; s.Color = Color3.fromRGB(80, 80, 90); s.Name = "BtnStroke"; s.Parent = b
        return b
    end

    espBtn = createExtraBtn("ESP", 0)
    nearBtn = createExtraBtn("面向最近玩家", 30)
    clickBtn = createExtraBtn("面向雙擊玩家", 60)

    -- 延伸按鈕邏輯
    local extended = false
    extBtn.Activated:Connect(function()
        extended = not extended
        extBtn.Text = extended and "收回" or "延伸"
        extBtn.TextColor3 = Color3.new(1, 1, 1)
        Tw:Create(extFrame, TweenInfo.new(0.3), {Size = UDim2.fromOffset(64, extended and 90 or 0)}):Play()
    end)

    btn.Activated:Connect(function()
        if lockMode == "shiftlock" then clearAllModes() else clearAllModes(); lockMode = "shiftlock"; lockMouse(true); setFaceRotation("shiftlock"); icn.Image = "rbxasset://textures/ui/mouseLock_on.png"; Tw:Create(btn, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(38, 48, 60)}):Play() end
    end)

    nearBtn.Activated:Connect(function()
        if lockMode == "nearest" then clearAllModes() else clearAllModes(); lockMode = "nearest"; updateButtonState(nearBtn, true); setFaceRotation("nearest") end
    end)

    clickBtn.Activated:Connect(function()
        if lockMode == "click" then clearAllModes()
        else
            clearAllModes(); lockMode = "click"; updateButtonState(clickBtn, true)
            mouseClickConn = plr:GetMouse().Button1Down:Connect(function()
                local mouse = plr:GetMouse(); local cam = Wk.CurrentCamera
                local ray = cam:ScreenPointToRay(mouse.X, mouse.Y)
                local foundPlayer = nil; local minDistance = math.huge
                for _, p in ipairs(Plrs:GetPlayers()) do
                    if p ~= plr and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
                        local hrp = p.Character.HumanoidRootPart
                        local rayToPlayer = hrp.Position - ray.Origin
                        local projection = rayToPlayer:Dot(ray.Direction.Unit)
                        if projection > 0 then
                            local closestPoint = ray.Origin + ray.Direction.Unit * projection
                            local distance = (hrp.Position - closestPoint).Magnitude
                            if distance < 8 and projection < minDistance then minDistance = projection; foundPlayer = p end
                        end
                    end
                end
                if foundPlayer and foundPlayer ~= plr then
                    local now = tick()
                    if lastClickedPlayer == foundPlayer and (now - lastClickTime) < 0.5 then targetPlayer = foundPlayer; setFaceRotation("click", foundPlayer) end
                    lastClickedPlayer = foundPlayer; lastClickTime = now
                end
            end)
        end
    end)

    -- ESP 功能
    local espEnabled = false
    local espLabels = {}
    local espBoxes = {}
    local espConn = nil

    local function cleanupESP(p)
        if espLabels[p] then
            if espLabels[p].billboard then espLabels[p].billboard:Destroy() end
            espLabels[p] = nil
        end
        if espBoxes[p] then
            espBoxes[p]:Destroy()
            espBoxes[p] = nil
        end
    end

    local function createESPBox(character)
        local box = Instance.new("BoxHandleAdornment")
        box.Name = "ESPBox"; box.AlwaysOnTop = true; box.ZIndex = 1
        box.Transparency = 0.7; box.Color3 = Color3.new(1, 1, 1); box.Parent = gui
        return box
    end

    espBtn.Activated:Connect(function()
        espEnabled = not espEnabled
        updateButtonState(espBtn, espEnabled)
        
        if not espEnabled then
            if espConn then espConn:Disconnect(); espConn = nil end
            for p, _ in pairs(espLabels) do cleanupESP(p) end
            for p, _ in pairs(espBoxes) do cleanupESP(p) end
        else
            espConn = RS.RenderStepped:Connect(function()
                local _, _, myHRP = getParts()
                for _, p in ipairs(Plrs:GetPlayers()) do
                    if p ~= plr then
                        local char = p.Character
                        local hrp = char and char:FindFirstChild("HumanoidRootPart")
                        local hum = char and char:FindFirstChildOfClass("Humanoid")
                        if char and hrp and hum and hum.Health > 0 then
                            if not espLabels[p] then
                                local bg = Instance.new("BillboardGui")
                                bg.Size = UDim2.fromOffset(200, 50); bg.AlwaysOnTop = true
                                bg.StudsOffset = Vector3.new(0, 3, 0); bg.Parent = gui
                                local tl = Instance.new("TextLabel")
                                tl.Size = UDim2.fromScale(1, 1); tl.BackgroundTransparency = 1
                                tl.TextColor3 = Color3.new(1, 1, 1); tl.TextStrokeTransparency = 0.5
                                tl.TextSize = 14; tl.Font = Enum.Font.SourceSansBold; tl.Parent = bg
                                espLabels[p] = {billboard = bg, label = tl}
                            end
                            if not espBoxes[p] then espBoxes[p] = createESPBox(char) end
                            local dist = myHRP and (myHRP.Position - hrp.Position).Magnitude or 0
                            local lab = espLabels[p]
                            lab.billboard.Adornee = hrp
                            lab.label.Text = string.format("名: %s\n血量: %.0f\n距離: %.1f", p.Name, hum.Health, dist)
                            local box = espBoxes[p]; box.Adornee = char; box.Size = char:GetExtentsSize()
                        else cleanupESP(p) end
                    end
                end
                for p, _ in pairs(espLabels) do if not Plrs:FindFirstChild(p.Name) then cleanupESP(p) end end
            end)
        end
    end)

    -- 拖曳功能
    local dragging, dragInput, dragStart, startPos
    
    dragHandle.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = btn.Position
            
            Tw:Create(dragHandle, TweenInfo.new(0.1), {BackgroundColor3 = Color3.fromRGB(150, 150, 160)}):Play()
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                    Tw:Create(dragHandle, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(100, 100, 110)}):Play()
                end
            end)
        end
    end)
    
    UIS.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            local delta = input.Position - dragStart
            btn.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)

    xBtn.Activated:Connect(function() 
        clearAllModes()
        if espConn then espConn:Disconnect() end
        for p, _ in pairs(espLabels) do cleanupESP(p) end
        gui:Destroy()
    end)
    
    plr.CharacterAdded:Connect(function()
        task.wait(0.5)
        if lockMode ~= "none" then setFaceRotation(lockMode, targetPlayer) end
    end)

    -- 初始化：自動啟動 ShiftLock
    task.wait(0.1)
    lockMode = "shiftlock"
    lockMouse(true)
    setFaceRotation("shiftlock")
    icn.Image = "rbxasset://textures/ui/mouseLock_on.png"
    Tw:Create(btn, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(38, 48, 60)}):Play()

    print("✅ ShiftLock + ESP 腳本已載入（預設啟動 ShiftLock）")
end

task.spawn(function() pcall(loadShiftLock) end)
